# Prepare_functions: common code for Prepare for imaging / clone / custom BPR
source ${codebase}/Common_functions || return 135

Run_apt_update() {

    [[ $aptcache_needs_update == 'Y' ]] || return 0

    Check_report_dest $Messages_O || return $?

    Pauze 'apt-get update'
    sudo apt-get update &>>${Messages_O} &
    Time_to_kill $! "Running apt-get update. Details in $Messages_O"
    export aptcache_needs_update='N'

    return 0
}

Apt_purge() {
    local packages=$1
    [[ -z $packages ]] && return 4
    Check_report_dest $Messages_O || return $?

    local RC=0
    if [ "${live_run}." != 'Y.' ]
    then
        Pauze 'DRY RUN: apt-get purge --auto-remove '$packages |tee -a ${Messages_O}
        return 0
    fi

    sudo apt-get purge --auto-remove $packages 2>>${Messages_O} || RC=$?

    return $RC
}

Apt_install() {
    local packages=$1
    [[ -z $packages ]] && return 4
    Check_report_dest $Messages_O || return $?

    local RC=0
    if [ "${live_run}." != 'Y.' ]
    then
        Pauze 'DRY RUN: apt-get install -V --show-progress '$packages |tee -a ${Messages_O}
        return 0
    fi

    sudo apt-get install -V --show-progress $packages 2>>${Messages_O} || RC=$?

    return $RC
}

Check_report_dest() {
    local report_file_out=$1

    [[ -z $report_file_out ]] && report_file_out=/tmp/prep_mess_dflt
    if [ ! -w $report_file_out ]
    then
        echo 'Problem writing to '$report_file_out
        return 12
    fi

    return 0
}

#Apt_action_replace() {
#    local packages=$1
#    [[ -z $packages ]] && return 4
#    shift 1
#    local replacements=$@
#
#    local RC=0
#    echo 'Attempting to replace' $packages 'with' $replacements
#    Apt_purge $packages ||RC=$?
#    if [ $RC -eq 0 ]
#    then
#        Apt_install $replacements ||RC=$?
#    fi
#
#    return $RC
#}

